/*! colorPicker - v2.0.0 - 2013-06-28 4:53:45 PM
* Copyright (c) 2013 Letao; Licensed  */
KISSY.add("kg/colorPicker/2.0.0/index",function(a,b,c){function d(b){var c=this;c.trigger=a.one(b.trigger),c.defaultColor=b.defaultColor||"#f00",c.complete=b.complete||function(){},c.colorList=[],c.color=c.defaultColor,c.isShow=!1,c.init()}var e=(b.all,a.DOM);return a.Event,a.extend(d,c,{init:function(){var b=this,c=a.guid("J_ColorPicker");b.cp=b.createColorPicker(c),b.canvas=b.cp.one("#"+c),b.picker=b.cp.one(".J_ColorTarget"),b.renderPicker(),b.hide(),b.colorSlider=[{hex:"ff0000",per:0},{hex:"ff00ff",per:42/256},{hex:"0000ff",per:85/256},{hex:"00ffff",per:127/256},{hex:"00ff00",per:2.0.0/256},{hex:"ffff00",per:.828125},{hex:"ff0000",per:1}],b.setter=b.cp.one(".J_SetColor"),b.setArrow=b.setter.one(".J_SetArrow"),b.trigger.on("click",function(a){a.preventDefault(),b.reLocation(),b.isShow?b.hide():b.show()}),b.setter.on("click",function(a){a.preventDefault();var c=b.moveArrow(a),d=b.newColor(c);b.setColor(d)})},createColorPicker:function(b){var c=e.create('<div class="ks-colorpicker"><div class="J_ColorBox"><canvas class="colorTable" id="'+b+'" width="256" height="256">\u60a8\u7684\u6d4f\u89c8\u5668\u4e0d\u652f\u6301Canvas\u6807\u7b7e\u3002</canvas>'+'<img src="http://img02.taobaocdn.com/tps/i2/T1SO8vFoVXXXc1zPrr-9-9.png" width="9" height="9" class="J_ColorTarget ks-colortarget">'+"</div>"+'<div class="J_SetColor">'+'<img src="http://img04.taobaocdn.com/tps/i4/T1_xdvFgtbXXbf40rs-25-246.png" width="25" height="246">'+'<span class="J_SetArrow"></span>'+"</div>"+"</div>");return a.one("body").append(c),a.one(c)},setColor:function(a){var b=this;b.defaultColor=a,b.renderPicker(),b.resetPicker()},renderPicker:function(){var a=this,b=a.getRgb();a.fillColor(b),a.pickColor()&&(a.color=a.pickColor())},getRgb:function(){var a=this,b=0,c=0,d=0,e=a.defaultColor;e=e.replace(/^\s+|\s+$/g,"");var f=/^#([0-9a-f]{3}|[0-9a-f]{6})$/gi,g=e.match(f);return g||(e="#f00"),-1!==e.indexOf("#")&&(e=e.replace("#","")),6===e.length?(b=e.substr(0,2).toLowerCase(),c=e.substr(2,2).toLowerCase(),d=e.substr(4,2).toLowerCase()):(b=e.substr(0,1).toLowerCase(),b=b+""+b,c=e.substr(1,1).toLowerCase(),c=c+""+c,d=e.substr(2,1).toLowerCase(),d=d+""+d),b=parseInt(b,16),c=parseInt(c,16),d=parseInt(d,16),{r:b,g:c,b:d}},fillColor:function(a){function b(a,b,c){var d=a.createLinearGradient(0,0,256,0);return d.addColorStop(0,b),d.addColorStop(1,c),d}var c=this,d=c.canvas[0],e=d.getContext("2d");e.width=256,e.height=256;for(var f=1,g=a.r*f/256,h=a.g*f/256,i=a.b*f/256,j=0,k=0,l=0,m=0,n=0;256>j;j+=f){var o=1===j.toString(16).length?"0"+j.toString(16):j.toString(16),p="#"+o+o+o;k+=g,l+=h,m+=i;var q=1===Math.floor(k).toString(16).length?"0"+Math.floor(k).toString(16):Math.floor(k).toString(16),r=1===Math.floor(l).toString(16).length?"0"+Math.floor(l).toString(16):Math.floor(l).toString(16),s=1===Math.floor(m).toString(16).length?"0"+Math.floor(m).toString(16):Math.floor(m).toString(16);c.colorList[n++]={r:[o,q],g:[o,r],b:[o,s]};var t="#"+q+r+s;e.fillStyle=b(e,p,t),e.fillRect(0,256-j-1,256,f)}},pickColor:function(){var a=this,b=!1,c=a.picker,d=a.cp.one(".J_ColorBox"),e=Math.floor(c.width()/2),f={},g={},h=[],i={x:0,y:0},j="";d.on("mousedown",function(g){b=!0,i.x=a.canvas.offset().left,i.y=a.canvas.offset().top,f.x=g.clientX,f.y=g.clientY;var h={left:f.x-i.x-e,top:f.y-i.y-e};h.left<-e?h.left=-e:h.left>d.width()-1-e&&(h.left=d.width()-1-e),h.top<-e?h.top=-e:h.top>d.height()-1-e&&(h.top=d.height()-1-e),c.css({left:h.left,top:h.top})}).on("mousemove",function(a){if(b){g.x=a.clientX,g.y=a.clientY;var f={left:g.x-i.x-e,top:g.y-i.y-e};f.left<-e?f.left=-e:f.left>d.width()-1-e&&(f.left=d.width()-1-e),f.top<-e?f.top=-e:f.top>d.height()-1-e&&(f.top=d.height()-1-e),c.css({left:f.left,top:f.top})}}).on("mouseup",function(c){if(b){b=!1,g.x=c.clientX,g.y=c.clientY,h[0]=Math.floor(g.x-i.x),h[1]=Math.floor(g.y-i.y),h[0]<1?h[0]=1:h[0]>d.width()&&(h[0]=d.width()),h[1]<1?h[1]=1:h[1]>d.height()&&(h[1]=d.height());var e=a.colorList[a.colorList.length-h[1]],f=(parseInt(e.r[1],16)-parseInt(e.r[0],16))/256,k=(parseInt(e.g[1],16)-parseInt(e.g[0],16))/256,l=(parseInt(e.b[1],16)-parseInt(e.b[0],16))/256,m=parseInt(e.r[0],16)+Math.floor(h[0]*f);m=1===m.toString(16).length?"0"+m.toString(16):m.toString(16);var n=parseInt(e.g[0],16)+Math.floor(h[0]*k);n=1===n.toString(16).length?"0"+n.toString(16):n.toString(16);var o=parseInt(e.b[0],16)+Math.floor(h[0]*l);o=1===o.toString(16).length?"0"+o.toString(16):o.toString(16),j="#"+m+n+o,a.color=j||a.defaultColor,a.complete&&a.complete()}}).on("selectstart",function(){return!1})},getColor:function(){var a=this;return a.color},resetPicker:function(){var a=this;a.picker.css({left:"auto",right:-Math.floor(a.picker.width()/2),top:-Math.floor(a.picker.height()/2)}),a.color=a.defaultColor,a.complete&&a.complete()},reLocation:function(){var a=this,b=a.trigger.offset();a.cp.css({left:b.left,top:b.top+a.trigger.height()+10})},show:function(){var a=this;a.cp.css("visibility","visible"),a.isShow=!0},hide:function(){var a=this;a.cp.css("visibility","hidden"),a.isShow=!1},moveArrow:function(a){var b=this,c=b.setter.offset().top,d=a.clientY,e=d-c;0>e?e=0:e>b.setter.height()&&(e=b.setter.height()-1);var f=e/b.setter.height();return e-=Math.floor(b.setArrow.outerHeight()/2),b.setArrow.css("top",e),f},newColor:function(a){for(var b=this,c=0;c<b.colorSlider.length-1;c++)if(a>=b.colorSlider[c].per&&a<=b.colorSlider[c+1].per){var d=b.createColor(c,a-b.colorSlider[c].per,b.colorSlider[c],b.colorSlider[c+1]);break}return d},createColor:function(a,b,c,d){var e=c.hex.substr(0,2),f=c.hex.substr(2,2),g=c.hex.substr(4,2),h=d.hex.substr(0,2),i=d.hex.substr(2,2),j=d.hex.substr(4,2),k=0,l=0,m=0;0===a||3===a?m=(parseInt(j,16)-parseInt(g,16))/(d.per-c.per)*b:1===a||4===a?k=(parseInt(h,16)-parseInt(e,16))/(d.per-c.per)*b:l=(parseInt(i,16)-parseInt(f,16))/(d.per-c.per)*b;var n=Math.floor(parseInt(e,16)+k).toString(16),o=Math.floor(parseInt(f,16)+l).toString(16),p=Math.floor(parseInt(g,16)+m).toString(16);n=1===n.length?"0"+n:n,o=1===o.length?"0"+o:o,p=1===p.length?"0"+p:p;var q="#"+n+o+p;return q}},{ATTRS:{}}),d},{requires:["node","base"]});